#!/usr/bin/env zsh

local rdir info cfgs core rom arch

rdir=${0:h:h}/Resources
info=${0:h:h}/info.plist

cfgs=( $rdir/*.cfg )
core=`plutil -extract EmuCorePath raw $info`
rom=`plutil -extract EmuROMPath raw $info`

if [[ -f $rdir/$core:t ]]; then
  core=$rdir/$core:t
fi
for r in $rom:t $rom:h:t/$rom:t; [[ -f $rdir/${r%\#*} ]] && {
  rom=$rdir/$r
}

a=( `uname -m` ) b=( `lipo -archs $core` ) c=( ${${b:*a}:-$b} )
if [[ $#c == 1 ]]; then
  arch=( --arch $c )
fi
open $arch -b com.libretro.dist.RetroArch --args $@ --appendconfig ${(j[|])cfgs} -L $core $rom
